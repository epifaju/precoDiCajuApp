<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Preference Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        .language-display {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Language Preference Test</h1>
    <p>This page tests the language preference functionality in the frontend application.</p>

    <div class="test-section">
        <h2>Current Language Status</h2>
        <div id="current-language" class="language-display">Loading...</div>
        <div id="language-source" class="info">Checking language source...</div>
    </div>

    <div class="test-section">
        <h2>Test Language Change</h2>
        <p>Select a language to test the change functionality:</p>
        <select id="language-selector">
            <option value="pt">Português</option>
            <option value="fr">Français</option>
            <option value="en">English</option>
        </select>
        <button onclick="testLanguageChange()">Test Language Change</button>
        <div id="change-result"></div>
    </div>

    <div class="test-section">
        <h2>Test API Integration</h2>
        <p>Test saving language preference to the backend:</p>
        <button onclick="testSaveLanguage()">Save Current Language to Backend</button>
        <div id="save-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Language Initialization</h2>
        <p>Test how the application initializes language on page load:</p>
        <button onclick="testLanguageInit()">Test Language Initialization</button>
        <div id="init-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="test-summary">
            <p>Run the tests above to see results here.</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';
        let testResults = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkCurrentLanguage();
            loadLanguageSelector();
        });

        function checkCurrentLanguage() {
            const currentLang = localStorage.getItem('i18nextLng') || 'pt';
            const authStorage = localStorage.getItem('precaju-auth-storage');
            let userLang = null;
            
            if (authStorage) {
                try {
                    const authData = JSON.parse(authStorage);
                    userLang = authData.state?.user?.preferredLanguage;
                } catch (e) {
                    console.warn('Error parsing auth storage:', e);
                }
            }

            document.getElementById('current-language').textContent = `Current Language: ${currentLang}`;
            
            let source = 'localStorage';
            if (userLang) {
                source = 'user preference (database)';
            } else if (navigator.language) {
                source = 'browser language';
            }
            
            document.getElementById('language-source').textContent = `Source: ${source}`;
        }

        function loadLanguageSelector() {
            const currentLang = localStorage.getItem('i18nextLng') || 'pt';
            document.getElementById('language-selector').value = currentLang;
        }

        function testLanguageChange() {
            const selectedLang = document.getElementById('language-selector').value;
            const resultDiv = document.getElementById('change-result');
            
            try {
                // Simulate language change
                localStorage.setItem('i18nextLng', selectedLang);
                localStorage.setItem('precaju-language', selectedLang);
                
                // Update display
                checkCurrentLanguage();
                loadLanguageSelector();
                
                resultDiv.innerHTML = '<div class="success">✓ Language change successful</div>';
                addTestResult('Language Change', true, 'Language changed successfully');
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">✗ Language change failed: ${error.message}</div>`;
                addTestResult('Language Change', false, error.message);
            }
        }

        async function testSaveLanguage() {
            const resultDiv = document.getElementById('save-result');
            const currentLang = localStorage.getItem('i18nextLng') || 'pt';
            
            try {
                // Get auth token
                const authStorage = localStorage.getItem('precaju-auth-storage');
                if (!authStorage) {
                    throw new Error('No authentication token found. Please login first.');
                }
                
                const authData = JSON.parse(authStorage);
                const token = authData.state?.accessToken;
                
                if (!token) {
                    throw new Error('No access token found. Please login first.');
                }

                // Save language preference
                const response = await fetch(`${API_BASE_URL}/api/v1/users/me`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        preferredLanguage: currentLang
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.preferredLanguage === currentLang) {
                    resultDiv.innerHTML = '<div class="success">✓ Language saved to backend successfully</div>';
                    addTestResult('Save Language', true, 'Language saved to backend');
                } else {
                    resultDiv.innerHTML = '<div class="error">✗ Language save failed: Response mismatch</div>';
                    addTestResult('Save Language', false, 'Response mismatch');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">✗ Language save failed: ${error.message}</div>`;
                addTestResult('Save Language', false, error.message);
            }
        }

        function testLanguageInit() {
            const resultDiv = document.getElementById('init-result');
            
            try {
                // Test the language initialization logic
                const authStorage = localStorage.getItem('precaju-auth-storage');
                let detectedLang = 'pt';
                let source = 'default';
                
                if (authStorage) {
                    try {
                        const authData = JSON.parse(authStorage);
                        if (authData.state?.user?.preferredLanguage) {
                            detectedLang = authData.state.user.preferredLanguage;
                            source = 'user preference';
                        }
                    } catch (e) {
                        console.warn('Error parsing auth storage:', e);
                    }
                }
                
                if (source === 'default') {
                    const storedLang = localStorage.getItem('precaju-language');
                    if (storedLang && ['pt', 'fr', 'en'].includes(storedLang)) {
                        detectedLang = storedLang;
                        source = 'localStorage';
                    } else {
                        const browserLang = navigator.language.split('-')[0];
                        if (['pt', 'fr', 'en'].includes(browserLang)) {
                            detectedLang = browserLang;
                            source = 'browser';
                        }
                    }
                }
                
                resultDiv.innerHTML = `
                    <div class="success">✓ Language initialization test passed</div>
                    <div class="info">Detected language: ${detectedLang} (source: ${source})</div>
                `;
                addTestResult('Language Initialization', true, `Detected: ${detectedLang} from ${source}`);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">✗ Language initialization test failed: ${error.message}</div>`;
                addTestResult('Language Initialization', false, error.message);
            }
        }

        function addTestResult(testName, success, message) {
            testResults.push({
                name: testName,
                success: success,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            });
            updateTestSummary();
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('test-summary');
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.success).length;
            const failedTests = totalTests - passedTests;
            
            let html = `
                <h3>Test Results Summary</h3>
                <p><strong>Total Tests:</strong> ${totalTests} | 
                   <strong>Passed:</strong> <span style="color: green;">${passedTests}</span> | 
                   <strong>Failed:</strong> <span style="color: red;">${failedTests}</span></p>
            `;
            
            if (testResults.length > 0) {
                html += '<h4>Test Details:</h4><ul>';
                testResults.forEach(result => {
                    const status = result.success ? '✓' : '✗';
                    const color = result.success ? 'green' : 'red';
                    html += `<li style="color: ${color};">${status} ${result.name} (${result.timestamp}): ${result.message}</li>`;
                });
                html += '</ul>';
            }
            
            summaryDiv.innerHTML = html;
        }
    </script>
</body>
</html>
