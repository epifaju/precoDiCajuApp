<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mise Ã  jour des dates d'expiration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .exportateur { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .actif { background-color: #d4edda; border-color: #c3e6cb; }
        .expire { background-color: #f8d7da; border-color: #f5c6cb; }
        .suspendu { background-color: #fff3cd; border-color: #ffeaa7; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Mise Ã  jour des dates d'expiration</h1>
        
        <div id="status"></div>
        
        <button onclick="loadExportateurs()">ğŸ“‹ Charger les exportateurs</button>
        <button onclick="updateAllDates()">ğŸ”„ Mettre Ã  jour toutes les dates</button>
        <button onclick="verifyResults()">âœ… VÃ©rifier les rÃ©sultats</button>
        
        <div id="exportateurs"></div>
        
        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1/exportateurs';
        let exportateurs = [];

        async function loadExportateurs() {
            try {
                showStatus('Chargement des exportateurs...', 'info');
                
                const response = await fetch(`${API_BASE}?size=100`);
                const data = await response.json();
                exportateurs = data.content;
                
                showStatus(`âœ… ${exportateurs.length} exportateurs chargÃ©s`, 'success');
                displayExportateurs();
                
            } catch (error) {
                showStatus(`âŒ Erreur: ${error.message}`, 'error');
            }
        }

        function displayExportateurs() {
            const container = document.getElementById('exportateurs');
            container.innerHTML = '<h2>ğŸ“‹ Exportateurs actuels</h2>';
            
            exportateurs.forEach(exportateur => {
                const statusClass = exportateur.actif ? 'actif' : 
                                  exportateur.expire ? 'expire' : 
                                  exportateur.suspendu ? 'suspendu' : '';
                
                const statusText = exportateur.actif ? 'âœ… Actif' : 
                                 exportateur.expire ? 'âš ï¸ ExpirÃ©' : 
                                 exportateur.suspendu ? 'ğŸš« Suspendu' : 'â“ Inconnu';
                
                container.innerHTML += `
                    <div class="exportateur ${statusClass}">
                        <strong>${exportateur.nom}</strong><br>
                        Statut: ${statusText}<br>
                        Date d'expiration: ${exportateur.dateExpiration}<br>
                        Type: ${exportateur.type}<br>
                        RÃ©gion: ${exportateur.regionName}
                    </div>
                `;
            });
        }

        async function updateAllDates() {
            if (exportateurs.length === 0) {
                showStatus('âŒ Veuillez d\'abord charger les exportateurs', 'error');
                return;
            }

            showStatus('Mise Ã  jour en cours...', 'info');
            let successCount = 0;
            let failCount = 0;

            for (const exportateur of exportateurs) {
                try {
                    const updateData = {
                        dateExpiration: '2026-01-15'
                    };

                    const response = await fetch(`${API_BASE}/${exportateur.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (response.ok) {
                        successCount++;
                        console.log(`âœ… Mis Ã  jour: ${exportateur.nom}`);
                    } else {
                        failCount++;
                        console.error(`âŒ Erreur pour: ${exportateur.nom}`);
                    }

                    // Pause pour Ã©viter de surcharger l'API
                    await new Promise(resolve => setTimeout(resolve, 200));

                } catch (error) {
                    failCount++;
                    console.error(`âŒ Erreur pour ${exportateur.nom}:`, error);
                }
            }

            showStatus(`âœ… Mise Ã  jour terminÃ©e: ${successCount} succÃ¨s, ${failCount} Ã©checs`, 'success');
            
            // Recharger les donnÃ©es
            setTimeout(() => {
                loadExportateurs();
            }, 1000);
        }

        async function verifyResults() {
            try {
                showStatus('VÃ©rification des rÃ©sultats...', 'info');
                
                const response = await fetch(`${API_BASE}?size=10`);
                const data = await response.json();
                
                let actifCount = 0;
                let expireCount = 0;
                let suspenduCount = 0;
                
                data.content.forEach(exportateur => {
                    if (exportateur.actif) actifCount++;
                    else if (exportateur.expire) expireCount++;
                    else if (exportateur.suspendu) suspenduCount++;
                });
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <h2>ğŸ“Š RÃ©sultats de la vÃ©rification</h2>
                    <div class="exportateur">
                        <strong>Statistiques:</strong><br>
                        âœ… Actifs: ${actifCount}<br>
                        âš ï¸ ExpirÃ©s: ${expireCount}<br>
                        ğŸš« Suspendus: ${suspenduCount}<br>
                        ğŸ“Š Total: ${data.content.length}
                    </div>
                `;
                
                showStatus('âœ… VÃ©rification terminÃ©e', 'success');
                
            } catch (error) {
                showStatus(`âŒ Erreur lors de la vÃ©rification: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // Charger automatiquement au dÃ©marrage
        window.onload = function() {
            showStatus('PrÃªt Ã  mettre Ã  jour les dates d\'expiration', 'info');
        };
    </script>
</body>
</html>



