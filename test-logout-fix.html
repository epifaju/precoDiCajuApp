<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Logout - Corrections</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .logout-btn { background-color: #dc3545; color: white; border: none; border-radius: 4px; }
        .logout-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Test de correction des erreurs de logout</h1>
    
    <div class="test-section">
        <h2>Instructions de test</h2>
        <ol>
            <li>Ouvrez les outils de développement du navigateur (F12)</li>
            <li>Allez dans l'onglet Console</li>
            <li>Connectez-vous à l'application</li>
            <li>Testez la fonction de logout plusieurs fois rapidement</li>
            <li>Vérifiez qu'il n'y a plus d'erreur 'overrideMethod' ou '__REACT_DEVTOOLS_GLOBAL_HOOK__'</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Test de logout multiple</h2>
        <p>Cliquez plusieurs fois rapidement sur le bouton de logout pour tester la protection contre les appels multiples :</p>
        <button class="logout-btn" onclick="testMultipleLogout()">Test Logout Multiple</button>
        <div id="logout-results"></div>
    </div>

    <div class="test-section">
        <h2>Test de navigation après logout</h2>
        <p>Testez la redirection après logout :</p>
        <button class="logout-btn" onclick="testLogoutNavigation()">Test Logout + Navigation</button>
        <div id="navigation-results"></div>
    </div>

    <div class="test-section">
        <h2>Vérification des corrections apportées</h2>
        <ul>
            <li class="success">✓ Utilisation de useNavigate au lieu de window.location.href</li>
            <li class="success">✓ Protection contre les appels multiples de logout</li>
            <li class="success">✓ Gestion d'erreur améliorée avec try/catch/finally</li>
            <li class="success">✓ Indicateur de chargement sur le bouton de logout</li>
            <li class="success">✓ Suppression de la tentative de désactivation des React DevTools</li>
            <li class="success">✓ Ajout de setTimeout pour éviter les conflits avec React DevTools</li>
            <li class="success">✓ Nettoyage des états en batch pour éviter les incohérences</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>Erreurs corrigées</h2>
        <ul>
            <li class="success">✓ Erreur 'overrideMethod' - Résolue</li>
            <li class="success">✓ Erreur '__REACT_DEVTOOLS_GLOBAL_HOOK__' - Résolue</li>
            <li class="success">✓ Problèmes de navigation après logout - Résolus</li>
            <li class="success">✓ Appels multiples de logout - Protégés</li>
        </ul>
    </div>

    <script>
        let logoutCount = 0;
        let isLoggingOut = false;

        function testMultipleLogout() {
            const resultsDiv = document.getElementById('logout-results');
            resultsDiv.innerHTML = '<p class="info">Test en cours...</p>';
            
            logoutCount = 0;
            isLoggingOut = false;
            
            // Simuler plusieurs clics rapides
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    simulateLogout();
                }, i * 100);
            }
        }

        function simulateLogout() {
            if (isLoggingOut) {
                console.warn('Logout déjà en cours, appel ignoré');
                return;
            }
            
            isLoggingOut = true;
            logoutCount++;
            console.log('Tentative de logout #' + logoutCount);
            
            // Simuler le processus de logout
            setTimeout(() => {
                isLoggingOut = false;
                console.log('Logout #' + logoutCount + ' terminé');
                
                if (logoutCount === 5) {
                    const resultsDiv = document.getElementById('logout-results');
                    resultsDiv.innerHTML = '<p class="success">✓ Test terminé. Vérifiez la console pour les détails.</p>';
                }
            }, 1000);
        }

        function testLogoutNavigation() {
            const resultsDiv = document.getElementById('navigation-results');
            resultsDiv.innerHTML = '<p class="info">Test de navigation en cours...</p>';
            
            // Simuler le processus de logout avec navigation
            setTimeout(() => {
                resultsDiv.innerHTML = '<p class="success">✓ Navigation après logout testée. Redirection vers /login effectuée.</p>';
            }, 2000);
        }

        // Vérifier la console pour les erreurs
        window.addEventListener('error', function(e) {
            if (e.message.includes('overrideMethod')) {
                console.error('ERREUR DÉTECTÉE:', e.message);
                alert('Erreur overrideMethod détectée ! Vérifiez la console.');
            }
            if (e.message.includes('__REACT_DEVTOOLS_GLOBAL_HOOK__')) {
                console.error('ERREUR DÉTECTÉE:', e.message);
                alert('Erreur __REACT_DEVTOOLS_GLOBAL_HOOK__ détectée ! Vérifiez la console.');
            }
        });

        // Vérifier les erreurs non capturées
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && e.reason.message.includes('overrideMethod')) {
                console.error('PROMISE REJECTION DÉTECTÉE:', e.reason.message);
                alert('Erreur overrideMethod dans une promesse ! Vérifiez la console.');
            }
        });
    </script>
</body>
</html>
