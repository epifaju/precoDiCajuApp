<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentification et Exportateurs</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .code { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; border-radius: 5px; font-family: monospace; margin: 10px 0; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.loading { background-color: #fff3cd; color: #856404; }
        .json-display { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîê Test Authentification et Exportateurs</h1>
    
    <div class="info">
        <h3>üìã Instructions</h3>
        <ol>
            <li>Assurez-vous que l'application frontend est ouverte dans un autre onglet</li>
            <li>Connectez-vous √† l'application si ce n'est pas d√©j√† fait</li>
            <li>Ex√©cutez les tests ci-dessous</li>
        </ol>
    </div>

    <h3>üß™ Tests</h3>
    <button onclick="testAuthentication()">Tester l'Authentification</button>
    <button onclick="testExportersEndpoint()">Tester l'Endpoint Exportateurs</button>
    <button onclick="testWithAuth()">Tester avec Token d'Auth</button>
    <button onclick="checkLocalStorage()">V√©rifier LocalStorage</button>
    <button onclick="openApplication()">Ouvrir l'Application</button>
    
    <div id="results"></div>

    <div class="info">
        <h3>üîç Diagnostic</h3>
        <p><strong>Probl√®me identifi√© :</strong> L'endpoint <code>/api/v1/exportateurs</code> n√©cessite une authentification</p>
        <p><strong>Cause possible :</strong> L'utilisateur n'est pas connect√© ou le token a expir√©</p>
        <p><strong>Solution :</strong> Se connecter √† l'application avant d'acc√©der √† la page Exportadores</p>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<div class="status ${statusClass}">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testAuthentication() {
            clearResults();
            log('üîê Test de l\'authentification...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Authentification OK', 'success');
                    log(`Utilisateur: ${data.email || 'Non sp√©cifi√©'}`, 'success');
                } else {
                    log(`‚ùå Authentification √©chou√©e (${response.status})`, 'error');
                    log('Vous devez vous connecter √† l\'application', 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
            }
        }

        async function testExportersEndpoint() {
            clearResults();
            log('üìä Test de l\'endpoint exportateurs...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/exportateurs?page=0&size=5`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Endpoint exportateurs accessible', 'success');
                    log(`Nombre d'exportateurs: ${data.content?.length || 0}`, 'success');
                } else if (response.status === 401) {
                    log('üîê Authentification requise (401)', 'warning');
                    log('Vous devez √™tre connect√© pour acc√©der aux exportateurs', 'warning');
                } else {
                    log(`‚ùå Erreur ${response.status}: ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
            }
        }

        async function testWithAuth() {
            clearResults();
            log('üîë Test avec token d\'authentification...', 'loading');
            
            // Essayer de r√©cup√©rer le token depuis localStorage
            const authData = localStorage.getItem('auth-storage');
            if (!authData) {
                log('‚ùå Aucun token trouv√© dans localStorage', 'error');
                log('Connectez-vous √† l\'application d\'abord', 'error');
                return;
            }
            
            try {
                const parsed = JSON.parse(authData);
                const token = parsed.state?.accessToken;
                
                if (!token) {
                    log('‚ùå Token d\'acc√®s non trouv√©', 'error');
                    return;
                }
                
                log('‚úÖ Token trouv√©, test de l\'endpoint...', 'success');
                
                const response = await fetch(`${API_BASE}/api/v1/exportateurs?page=0&size=5`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Endpoint accessible avec authentification', 'success');
                    log(`Nombre d'exportateurs: ${data.content?.length || 0}`, 'success');
                    log(`Total: ${data.totalElements || 0}`, 'success');
                } else {
                    log(`‚ùå Erreur ${response.status}: ${response.statusText}`, 'error');
                    const errorText = await response.text();
                    log(`D√©tails: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        function checkLocalStorage() {
            clearResults();
            log('üíæ V√©rification du LocalStorage...', 'loading');
            
            const authData = localStorage.getItem('auth-storage');
            if (!authData) {
                log('‚ùå Aucune donn√©e d\'authentification trouv√©e', 'error');
                log('Vous devez vous connecter √† l\'application', 'error');
                return;
            }
            
            try {
                const parsed = JSON.parse(authData);
                log('‚úÖ Donn√©es d\'authentification trouv√©es', 'success');
                
                const state = parsed.state;
                if (state) {
                    log(`Utilisateur: ${state.user?.email || 'Non sp√©cifi√©'}`, 'info');
                    log(`Connect√©: ${state.isAuthenticated ? 'Oui' : 'Non'}`, 'info');
                    log(`Token pr√©sent: ${state.accessToken ? 'Oui' : 'Non'}`, 'info');
                    
                    if (state.accessToken) {
                        log('üîë Token d\'acc√®s trouv√©', 'success');
                    } else {
                        log('‚ùå Token d\'acc√®s manquant', 'error');
                    }
                }
                
                log('<strong>Donn√©es compl√®tes:</strong>', 'info');
                log(`<div class="json-display">${JSON.stringify(parsed, null, 2)}</div>`, 'info');
            } catch (error) {
                log(`‚ùå Erreur de parsing: ${error.message}`, 'error');
            }
        }

        function openApplication() {
            window.open('http://localhost:3002', '_blank');
        }

        // Test automatique au chargement
        window.onload = function() {
            setTimeout(() => {
                checkLocalStorage();
            }, 1000);
        };
    </script>
</body>
</html>
